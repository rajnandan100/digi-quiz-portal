<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control Panel - Digi Quiz Portal722</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* Navigation */
        .navbar {
            background: rgba(239, 68, 68, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }
        .navbar-brand {
            font-weight: 700;
        }
        
        /* Main Container */
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem;
            padding: 0;
            overflow: hidden;
        }
        
        /* Stats Cards - Enhanced Design */
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.5);
        }
        .stats-card h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .stats-card p {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        /* Cards */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        /* Forms */
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        /* Buttons */
        .btn {
            border-radius: 10px;
            font-weight: 500;
            padding: 0.6rem 1.5rem;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-1px);
        }
        
        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }
        
        /* API Status */
        .api-status {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .api-status.connected {
            background: #d1f2eb;
            color: #0d8457;
        }
        .api-status.disconnected {
            background: #fadbd8;
            color: #922b21;
        }
        
        /* Tables */
        .table th {
            font-weight: 600;
            background: #f8fafc;
            border-top: none;
        }
        
        /* Animations */
        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Tab Navigation */
        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            border: none;
            color: #64748b;
            font-weight: 500;
            margin-right: 0.5rem;
        }
        .nav-tabs .nav-link.active {
            background: #667eea;
            color: white;
        }
        
        /* JSON Editor */
        #questionsJson {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        /* Success/Error Messages */
        .alert {
            border-radius: 10px;
            border: none;
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card text-center">
            <div class="mb-4">
                <i class="fas fa-shield-alt text-primary" style="font-size: 3rem;"></i>
                <h3 class="mt-3 mb-2">Admin Access</h3>
                <p class="text-muted">Enter your credentials to continue</p>
            </div>
            <form id="adminLoginForm">
                <div class="mb-3">
                    <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
            </form>
            <div class="mt-3">
                <small class="text-muted">Secure admin panel for DigiQuiz Portal</small>
            </div>
        </div>
    </div>

    <!-- NAVIGATION -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-graduation-cap me-2"></i>
                DigiQuiz Portal - Admin
            </a>
            <div class="d-flex align-items-center">
                <span class="api-status connected me-3">
                    <i class="fas fa-wifi me-1"></i>Connected
                </span>
                <span class="text-light me-3">
                    <i class="fas fa-clock me-1"></i>
                    <span id="lastUpdateTime">Loading...</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="adminLogout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div id="adminContent" class="container-fluid p-0" style="display: none;">
        <div class="main-container">
            
            <!-- DASHBOARD STATS - Updated to 3 cards (removed analytics) -->
            <div class="p-4">
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="stats-card fade-in-up">
                            <h2 id="totalQuizzesCount">0</h2>
                            <p class="mb-0">Total Quizzes</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card fade-in-up">
                            <h2 id="totalAttemptsCount">0</h2>
                            <p class="mb-0">Total Attempts</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card fade-in-up">
                            <h2 id="totalQuestionsCount">0</h2>
                            <p class="mb-0">Total Questions</p>
                        </div>
                    </div>
                </div>

                <!-- TABS NAVIGATION -->
                <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#createQuiz" type="button" role="tab">
                            <i class="fas fa-plus me-2"></i>Create Quiz
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manageQuizzes" type="button" role="tab">
                            <i class="fas fa-list me-2"></i>Manage Quizzes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="attempts-tab" data-bs-toggle="tab" data-bs-target="#viewAttempts" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>View Attempts
                        </button>
                    </li>
                </ul>

                <!-- TAB CONTENT -->
                <div class="tab-content" id="adminTabsContent">
                    
                    <!-- CREATE QUIZ TAB -->
                    <div class="tab-pane fade show active" id="createQuiz" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-plus text-primary me-2"></i>
                                    Create New Quiz
                                </h5>
                                <p class="text-muted mb-0">Fill the form below to create a new quiz</p>
                            </div>
                            <div class="card-body">
                                <form id="createQuizForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="quizDateInput" class="form-label">Quiz Date</label>
                                            <input type="date" class="form-control" id="quizDateInput" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="subjectInput" class="form-label">Subject</label>
                                            <select class="form-select" id="subjectInput" required>
                                                <option value="">Select Subject</option>
                                                <option value="Mathematics">Mathematics</option>
                                                <option value="Science">Science</option>
                                                <option value="English">English</option>
                                                <option value="History">History</option>
                                                <option value="Geography">Geography</option>
                                                <option value="Computer Science">Computer Science</option>
                                                <option value="General Knowledge">General Knowledge</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="questionsJson" class="form-label">Questions (JSON Format)</label>
                                        <textarea class="form-control" id="questionsJson" rows="12" placeholder="Paste your questions in JSON format here..." required></textarea>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <strong>Validation Results:</strong>
                                                <span id="questionCount">0</span> questions, 
                                                <span id="totalTime">0 min</span> total time
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-secondary" onclick="validateJSON()">
                                            <i class="fas fa-check me-1"></i>Validate JSON
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i>Create Quiz
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- MANAGE QUIZZES TAB -->
                    <div class="tab-pane fade" id="manageQuizzes" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">
                                        <i class="fas fa-list text-primary me-2"></i>
                                        All Quizzes
                                    </h5>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadQuizzes()">
                                    <i class="fas fa-refresh me-1"></i>Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Date</th>
                                                <th>Subject</th>
                                                <th>Questions</th>
                                                <th>Duration</th>
                                                <th>Attempts</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="quizzesTable">
                                            <tr>
                                                <td colspan="7" class="text-center">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW ATTEMPTS TAB -->
                    <div class="tab-pane fade" id="viewAttempts" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">
                                        <i class="fas fa-users text-primary me-2"></i>
                                        All Quiz Attempts
                                    </h5>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="loadQuizAttempts()">
                                    <i class="fas fa-refresh me-1"></i>Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Name</th>
                                                <th>Quiz</th>
                                                <th>Score</th>
                                                <th>Accuracy</th>
                                                <th>Time</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="attemptsTable">
                                            <tr>
                                                <td colspan="7" class="text-center">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="api.js"></script>
    <script src="utils.js"></script>

    <script>
        // Admin Authentication
        let adminLoggedIn = false;

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('quizDateInput').valueAsDate = new Date();
            
            // Auto-validate JSON on input
            document.getElementById('questionsJson').addEventListener('input', validateJSON);
            
            // Setup form handlers
            document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
            document.getElementById('createQuizForm').addEventListener('submit', handleCreateQuiz);
            
            // Load initial data
            updateLastUpdateTime();
            setInterval(updateLastUpdateTime, 60000); // Update every minute
        });

        // Admin Login Handler
        function handleAdminLogin(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            if (password === 'DigiQuizMaster2025@!') {
                adminLoggedIn = true;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                
                // Load initial dashboard data
                loadDashboardStats();
                loadQuizzes();
                loadQuizAttempts();
                
                Swal.fire({
                    title: 'Login Successful!',
                    text: 'Welcome to DigiQuiz Admin Panel',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    title: 'Invalid Password',
                    text: 'Please check your credentials and try again',
                    icon: 'error'
                });
            }
        }

        // Admin Logout
        function adminLogout() {
            Swal.fire({
                title: 'Are you sure?',
                text: 'You will be logged out of the admin panel',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, logout',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    adminLoggedIn = false;
                    document.getElementById('loginOverlay').style.display = 'flex';
                    document.getElementById('adminContent').style.display = 'none';
                    document.getElementById('adminPassword').value = '';
                }
            });
        }

        // FIXED: JSON Validation Function - Duration Bug Corrected
        function validateJSON() {
            const jsonInput = document.getElementById('questionsJson').value.trim();
            let questionCount = 0;
            let totalTime = 0;
            let isValid = false;
            
            try {
                if (jsonInput) {
                    const questions = JSON.parse(jsonInput);
                    if (Array.isArray(questions)) {
                        questionCount = questions.length;
                        // FIX: Calculate total time correctly (sum seconds, then convert to minutes)
                        totalTime = questions.reduce((sum, q) => sum + (q.timeAllocation || 60), 0);
                        
                        // Validate structure
                        isValid = true;
                        for (let i = 0; i < questions.length; i++) {
                            const q = questions[i];
                            if (!q.question || !q.options || !Array.isArray(q.options) || q.options.length !== 4 ||
                                q.correctAnswer === undefined || q.correctAnswer < 0 || q.correctAnswer > 3 ||
                                !q.explanation) {
                                isValid = false;
                                throw new Error(`Question ${i + 1} has invalid structure`);
                            }
                        }
                        
                        if (isValid && questionCount > 0) {
                            console.log('✅ JSON validation successful');
                        }
                    }
                }
            } catch (error) {
                console.error('JSON validation error:', error);
                isValid = false;
            }
            
            document.getElementById('questionCount').textContent = questionCount;
            // FIX: Display time correctly (divide seconds by 60 to get minutes)
            document.getElementById('totalTime').textContent = Math.round(totalTime / 60) + ' min';
            
            // FIX: Return time in seconds for proper API submission
            return { valid: isValid && questionCount > 0, count: questionCount, time: totalTime };
        }

        // Enhanced Quiz Creation Handler
        async function handleCreateQuiz(e) {
            e.preventDefault();
            
            const date = document.getElementById('quizDateInput').value;
            const subject = document.getElementById('subjectInput').value;
            const jsonInput = document.getElementById('questionsJson').value.trim();
            
            const validation = validateJSON();
            
            if (!validation.valid) {
                Swal.fire({
                    title: 'Invalid JSON',
                    text: 'Please check your JSON format and try again',
                    icon: 'error'
                });
                return;
            }

            const quizData = {
                date: date,
                subject: subject,
                questions: JSON.parse(jsonInput),
                totalQuestions: validation.count,
                timeLimit: validation.time // This is now in seconds
            };

            try {
                const result = await createQuizAPI(quizData);
                
                Swal.fire({
                    title: 'Success!',
                    text: 'Quiz created successfully',
                    icon: 'success'
                });
                
                // Reset form
                document.getElementById('createQuizForm').reset();
                document.getElementById('quizDateInput').valueAsDate = new Date();
                
                // Refresh data
                loadDashboardStats();
                loadQuizzes();
                
            } catch (error) {
                console.error('Error creating quiz:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to create quiz. Please try again.',
                    icon: 'error'
                });
            }
        }

        // Load Dashboard Statistics
        async function loadDashboardStats() {
            try {
                const quizzes = await getQuizzesAPI();
                const attempts = await getLeaderboardAPI('all');
                
                document.getElementById('totalQuizzesCount').textContent = quizzes.length;
                document.getElementById('totalAttemptsCount').textContent = attempts.length;
                
                // Calculate total questions
                const totalQuestions = quizzes.reduce((sum, quiz) => sum + parseInt(quiz.totalQuestions || 0), 0);
                document.getElementById('totalQuestionsCount').textContent = totalQuestions;
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Load and Display Quizzes
        async function loadQuizzes() {
            try {
                const quizzes = await getQuizzesAPI();
                const tbody = document.getElementById('quizzesTable');
                
                if (quizzes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No quizzes found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = quizzes.map((quiz, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${formatDate(quiz.date)}</td>
                        <td><span class="badge bg-primary">${quiz.subject}</span></td>
                        <td>${quiz.totalQuestions}</td>
                        <td>${Math.round(quiz.timeLimit / 60)} min</td>
                        <td>${quiz.attempts || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteQuiz('${quiz.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading quizzes:', error);
                document.getElementById('quizzesTable').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Error loading quizzes</td></tr>';
            }
        }

        // Enhanced Load Quiz Attempts Function
        async function loadQuizAttempts() {
            try {
                const attempts = await getLeaderboardAPI('all');
                const tbody = document.getElementById('attemptsTable');
                
                if (attempts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No attempts found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = attempts.map((attempt, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${attempt.userName || 'Anonymous'}</td>
                        <td><span class="badge bg-info">${attempt.subject || 'N/A'}</span></td>
                        <td><strong>${attempt.score}/${attempt.totalQuestions}</strong></td>
                        <td>${attempt.percentage}%</td>
                        <td>${attempt.timeTaken || '00:00'}</td>
                        <td>${formatDate(attempt.date)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading attempts:', error);
                document.getElementById('attemptsTable').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Error loading attempts</td></tr>';
            }
        }

        // Delete Quiz Function
        async function deleteQuiz(quizId) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: 'This will permanently delete the quiz',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            });

            if (result.isConfirmed) {
                // Implement delete functionality
                Swal.fire('Deleted!', 'Quiz has been deleted.', 'success');
                loadQuizzes();
                loadDashboardStats();
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString('en-IN', {
                hour12: true,
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html>
