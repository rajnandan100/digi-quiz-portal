<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control Panel - Digi Quiz Portal</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* Navigation */
        .navbar {
            background: rgba(239, 68, 68, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        }
        .navbar-brand {
            font-weight: 700;
        }
        
        /* Main Container */
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem;
            padding: 0;
            overflow: hidden;
        }
        
        /* Cards */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        /* Stats Cards */
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }
        .stats-card h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        /* Tabs */
        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 1rem 1.5rem;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }
        
        /* Forms */
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        /* Buttons */
        .btn {
            border-radius: 10px;
            font-weight: 500;
            padding: 0.6rem 1.5rem;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-1px);
        }
        
        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
        }
        
        /* API Status */
        .api-status {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .api-status.connected {
            background: #d1f2eb;
            color: #0d8457;
        }
        .api-status.disconnected {
            background: #fadbd8;
            color: #a93226;
        }
        .api-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .api-status.connected::before {
            background: #0d8457;
        }
        .api-status.disconnected::before {
            background: #a93226;
        }
        
        /* Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.6s ease forwards;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                margin: 1rem;
                border-radius: 15px;
            }
            .stats-card h2 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    
    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                <h2>Admin Access Required</h2>
                <p class="text-muted">Enter your admin password to continue</p>
            </div>
            
            <form id="adminLoginForm">
                <div class="mb-3">
                    <input type="password" class="form-control" id="adminPassword" placeholder="Enter admin password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <div id="loginError" class="alert alert-danger mt-3" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>Invalid password!
                </div>
            </form>
        </div>
    </div>

    <!-- MAIN NAVIGATION -->
    <nav id="adminNav" class="navbar navbar-expand-lg navbar-dark bg-primary" style="display: none;">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-tachometer-alt me-2"></i>
                DigiQuizMaster Admin
            </a>
            
            <div class="d-flex align-items-center">
                <span id="apiStatus" class="api-status disconnected me-3">
                    <span id="apiStatusText">Checking API...</span>
                </span>
                <span class="text-white me-3">
                    <i class="fas fa-clock me-1"></i>
                    <span id="lastUpdateTime">Loading...</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="adminLogout()">
                    <i class="fas fa-sign-out-alt me-1"></i>Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div id="adminContent" class="container-fluid p-0" style="display: none;">
        <div class="main-container">
            
            <!-- DASHBOARD STATS -->
            <div class="p-4">
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stats-card fade-in-up">
                            <h2 id="totalQuizzesCount">0</h2>
                            <p class="mb-0">Total Quizzes</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card fade-in-up">
                            <h2 id="totalAttemptsCount">0</h2>
                            <p class="mb-0">Total Attempts</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card fade-in-up">
                            <h2 id="todayQuizzesCount">0</h2>
                            <p class="mb-0">Today's Quizzes</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card fade-in-up">
                            <h2 id="totalQuestionsCount">0</h2>
                            <p class="mb-0">Total Questions</p>
                        </div>
                    </div>
                </div>

                <!-- TABS NAVIGATION -->
                <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#createQuiz" type="button" role="tab">
                            <i class="fas fa-plus me-2"></i>Create Quiz
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manageQuizzes" type="button" role="tab">
                            <i class="fas fa-list me-2"></i>Manage Quizzes
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="attempts-tab" data-bs-toggle="tab" data-bs-target="#viewAttempts" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>View Attempts
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                            <i class="fas fa-chart-bar me-2"></i>Analytics
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                            <i class="fas fa-cog me-2"></i>Settings
                        </button>
                    </li>
                </ul>

                <!-- TABS CONTENT -->
                <div class="tab-content" id="adminTabsContent">
                    
                    <!-- CREATE QUIZ TAB -->
                    <div class="tab-pane fade show active" id="createQuiz" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-plus me-2"></i>Create New Quiz
                                </h5>
                                <small>Fill the form below to create a new quiz</small>
                            </div>
                            <div class="card-body">
                                <form id="quizCreationForm">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="quizDateInput" class="form-label">
                                                <i class="fas fa-calendar me-1"></i>Quiz Date
                                            </label>
                                            <input type="date" class="form-control" id="quizDateInput" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="subjectInput" class="form-label">
                                                <i class="fas fa-book me-1"></i>Subject
                                            </label>
                                            <select class="form-select" id="subjectInput" required>
                                                <option value="">Select Subject</option>
                                                <option value="Mathematics">Mathematics</option>
                                                <option value="Science">Science</option>
                                                <option value="English">English</option>
                                                <option value="History">History</option>
                                                <option value="Geography">Geography</option>
                                                <option value="General Knowledge">General Knowledge</option>
                                                <option value="Computer Science">Computer Science</option>
                                                <option value="Economics">Economics</option>
                                                <option value="Physics">Physics</option>
                                                <option value="Chemistry">Chemistry</option>
                                                <option value="Biology">Biology</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="mt-4">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label for="questionsJson" class="form-label">
                                                <i class="fas fa-list me-1"></i>Questions (JSON Format)
                                            </label>
                                            <div>
                                                <button type="button" class="btn btn-sm btn-outline-info me-2" onclick="copyTemplate()">
                                                    <i class="fas fa-copy me-1"></i>Copy Template
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-success" onclick="loadSampleQuiz()">
                                                    <i class="fas fa-download me-1"></i>Load Sample
                                                </button>
                                            </div>
                                        </div>
                                        <textarea class="form-control" id="questionsJson" rows="10" placeholder="Paste your questions JSON here..." required></textarea>
                                        
                                        <div class="row mt-3">
                                            <div class="col-md-4">
                                                <div class="alert alert-info">
                                                    <strong>Questions:</strong> <span id="questionCount">0</span>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="alert alert-warning">
                                                    <strong>Duration:</strong> <span id="totalTime">0 min</span>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <button type="button" class="btn btn-outline-primary w-100" onclick="validateJSON()">
                                                    <i class="fas fa-check me-1"></i>Validate JSON
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-4">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-save me-2"></i>Create Quiz
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- MANAGE QUIZZES TAB -->
                    <div class="tab-pane fade" id="manageQuizzes" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-list me-2"></i>All Quizzes
                                </h5>
                                <div>
                                    <button class="btn btn-sm btn-light" onclick="loadAllQuizzes()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                    <button class="btn btn-sm btn-warning ms-2" onclick="selectAllQuizzes()">
                                        <i class="fas fa-check-square me-1"></i>Select All
                                    </button>
                                    <button class="btn btn-sm btn-danger ms-2" onclick="deleteSelectedQuizzes()">
                                        <i class="fas fa-trash me-1"></i>Delete Selected
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-dark">
                                            <tr>
                                                <th width="3%">
                                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                                </th>
                                                <th width="5%">#</th>
                                                <th><i class="fas fa-calendar me-1"></i>Date</th>
                                                <th><i class="fas fa-book me-1"></i>Subject</th>
                                                <th><i class="fas fa-list-ol me-1"></i>Questions</th>
                                                <th><i class="fas fa-clock me-1"></i>Duration</th>
                                                <th><i class="fas fa-users me-1"></i>Attempts</th>
                                                <th><i class="fas fa-cog me-1"></i>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="allQuizzesTable">
                                            <tr>
                                                <td colspan="8" class="text-center py-4">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW ATTEMPTS TAB -->
                    <div class="tab-pane fade" id="viewAttempts" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i>All Quiz Attempts
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>#</th>
                                                <th>Name</th>
                                                <th>Quiz</th>
                                                <th>Score</th>
                                                <th>Accuracy</th>
                                                <th>Time</th>
                                                <th>Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="attemptsTable">
                                            <tr>
                                                <td colspan="8" class="text-center py-4">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ANALYTICS TAB -->
                    <div class="tab-pane fade" id="analytics" role="tabpanel">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-chart-pie me-2"></i>Subject Distribution</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="subjectChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-chart-line me-2"></i>Performance Trends</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="performanceChart" height="300"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SETTINGS TAB -->
                    <div class="tab-pane fade" id="settings" role="tabpanel">
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5><i class="fas fa-key me-2"></i>Security Settings</h5>
                                    </div>
                                    <div class="card-body">
                                        <form id="changePasswordForm">
                                            <div class="mb-3">
                                                <label class="form-label">Current Password</label>
                                                <input type="password" class="form-control" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">New Password</label>
                                                <input type="password" class="form-control" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-1"></i>Change Password
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Ultra-secure 20-character admin password
        const ADMIN_PASSWORD = 'DigiQuizMaster2025@!';
        let isAuthenticated = false;

        // FIXED: Your Google Apps Script URL with additional error handling
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgCXXszcRGsH4ZdQec2eahzj1DZHnsxbXhJmiMLYoslnz8c1qXmMtHOq28-0vG9FIVDA/exec';

        document.addEventListener('DOMContentLoaded', () => {
            // Check if already authenticated
            if (sessionStorage.getItem('adminAuthenticated') === 'true') {
                showAdminPanel();
            }
            
            setupEventListeners();
            setDefaultDate();
            initializeCharts();
        });

        function setupEventListeners() {
            // Login form
            document.getElementById('adminLoginForm').addEventListener('submit', handleLogin);
            
            // Quiz creation form
            document.getElementById('quizCreationForm').addEventListener('submit', handleCreateQuiz);
            
            // Change password form
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            
            // JSON validation on input
            document.getElementById('questionsJson').addEventListener('input', validateJSON);
            
            // Add tab click listener for manage quizzes
            const manageTab = document.querySelector('button[data-bs-target="#manageQuizzes"]');
            if (manageTab) {
                manageTab.addEventListener('click', () => {
                    setTimeout(() => loadAllQuizzes(), 300);
                });
            }
            
            // API status check
            checkAPIStatus();
            setInterval(checkAPIStatus, 30000);
        }

        function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminAuthenticated', 'true');
                showAdminPanel();
            } else {
                document.getElementById('loginError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            }
        }

        function showAdminPanel() {
            isAuthenticated = true;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('adminNav').style.display = 'block';
            document.getElementById('adminContent').style.display = 'block';
            
            loadDashboardStats();
            updateLastUpdateTime();
            loadAnalytics();
        }

        function adminLogout() {
            sessionStorage.removeItem('adminAuthenticated');
            location.reload();
        }

        // ENHANCED: API Status Check with detailed logging
        async function checkAPIStatus() {
            const statusElement = document.getElementById('apiStatus');
            const statusText = document.getElementById('apiStatusText');
            
            if (!statusElement || !statusText) return;
            
            try {
                console.log('üîç Testing API connection to:', GOOGLE_APPS_SCRIPT_URL);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=ping&t=${Date.now()}`, {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                    },
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ API response:', result);
                    
                    statusElement.className = 'api-status connected me-3';
                    statusText.textContent = `API Connected (v${result.version || '1.0'})`;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('‚ùå API connection failed:', error);
                
                statusElement.className = 'api-status disconnected me-3';
                
                if (error.name === 'AbortError') {
                    statusText.textContent = 'API Timeout';
                } else if (error.message.includes('CORS')) {
                    statusText.textContent = 'CORS Error';
                } else if (error.message.includes('Failed to fetch')) {
                    statusText.textContent = 'Network Error';
                } else {
                    statusText.textContent = 'API Error';
                }
            }
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quizDateInput').value = today;
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('en-IN');
        }

        // FIXED: JSON Validation Function
        function validateJSON() {
            const jsonInput = document.getElementById('questionsJson').value.trim();
            let questionCount = 0;
            let totalTime = 0;
            let isValid = false;
            
            try {
                if (jsonInput) {
                    const questions = JSON.parse(jsonInput);
                    if (Array.isArray(questions)) {
                        questionCount = questions.length;
                        totalTime = questions.reduce((sum, q) => sum + (q.timeAllocation || 60), 0);
                        
                        // Validate structure
                        isValid = true;
                        for (let i = 0; i < questions.length; i++) {
                            const q = questions[i];
                            if (!q.question || !q.options || !Array.isArray(q.options) || q.options.length !== 4 ||
                                q.correctAnswer === undefined || q.correctAnswer < 0 || q.correctAnswer > 3 ||
                                !q.explanation) {
                                isValid = false;
                                throw new Error(`Question ${i + 1} has invalid structure`);
                            }
                        }
                        
                        if (isValid && questionCount > 0) {
                            console.log('‚úÖ JSON validation successful');
                        }
                    }
                }
            } catch (error) {
                console.error('JSON validation error:', error);
                isValid = false;
            }
            
            document.getElementById('questionCount').textContent = questionCount;
            document.getElementById('totalTime').textContent = Math.round(totalTime / 60) + ' min';
            
            return { valid: isValid && questionCount > 0, count: questionCount, time: totalTime };
        }

        // COMPLETELY REWRITTEN: Quiz Creation with Multiple Fallbacks
        async function handleCreateQuiz(e) {
            e.preventDefault();
            
            const date = document.getElementById('quizDateInput').value;
            const subject = document.getElementById('subjectInput').value;
            const jsonInput = document.getElementById('questionsJson').value.trim();
            
            const validation = validateJSON();
            if (!validation.valid) {
                Swal.fire({
                    title: 'Invalid JSON!',
                    text: 'Please provide valid questions JSON format',
                    icon: 'error',
                    confirmButtonText: 'Fix JSON'
                });
                return;
            }
            
            try {
                const questions = JSON.parse(jsonInput);
                const quiz = {
                    quizId: `quiz_${Date.now()}`,
                    date: date,
                    subject: subject,
                    questions: questions,
                    totalQuestions: questions.length,
                    timeLimit: validation.time,
                    created: new Date().toISOString()
                };
                
                // Show loading
                Swal.fire({
                    title: 'Creating Quiz...',
                    html: 'Please wait while we save your quiz...',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Save locally first (backup)
                const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                quizzes.push(quiz);
                localStorage.setItem('quizzes', JSON.stringify(quizzes));
                
                let googleSheetsSuccess = false;
                
                try {
                    // Try to save to Google Sheets
                    const formData = new URLSearchParams();
                    formData.append('action', 'createQuiz');
                    formData.append('date', quiz.date);
                    formData.append('subject', quiz.subject);
                    formData.append('questionsJson', JSON.stringify(quiz.questions));
                    formData.append('totalQuestions', quiz.totalQuestions.toString());
                    formData.append('timeLimit', quiz.timeLimit.toString());
                    formData.append('quizId', quiz.quizId);
                    
                    const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: formData.toString(),
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'success') {
                            googleSheetsSuccess = true;
                        }
                    }
                } catch (error) {
                    console.warn('Google Sheets sync failed:', error);
                }
                
                // Show results
                if (googleSheetsSuccess) {
                    Swal.fire({
                        title: 'Quiz Created Successfully!',
                        html: `
                            <div style="text-align: left;">
                                <p>‚úÖ <strong>Subject:</strong> ${quiz.subject}</p>
                                <p>‚úÖ <strong>Questions:</strong> ${quiz.totalQuestions}</p>
                                <p>‚úÖ <strong>Duration:</strong> ${Math.round(quiz.timeLimit/60)} minutes</p>
                                <p>‚úÖ <strong>Saved to:</strong> Local Storage + Google Sheets</p>
                            </div>
                        `,
                        icon: 'success',
                        confirmButtonText: 'Great!',
                        timer: 5000
                    });
                } else {
                    Swal.fire({
                        title: 'Quiz Created Locally',
                        html: `
                            <div style="text-align: left;">
                                <p>‚úÖ <strong>Subject:</strong> ${quiz.subject}</p>
                                <p>‚úÖ <strong>Questions:</strong> ${quiz.totalQuestions}</p>
                                <p>‚ö†Ô∏è <strong>Note:</strong> Saved locally only. Google Sheets sync failed.</p>
                            </div>
                        `,
                        icon: 'warning',
                        confirmButtonText: 'Continue'
                    });
                }
                
                // Reset form
                document.getElementById('quizCreationForm').reset();
                setDefaultDate();
                validateJSON();
                
                // Refresh data
                loadDashboardStats();
                
            } catch (error) {
                Swal.fire({
                    title: 'Quiz Creation Failed',
                    text: 'Error: ' + error.message,
                    icon: 'error',
                    confirmButtonText: 'Try Again'
                });
                console.error('‚ùå Quiz creation failed:', error);
            }
        }

        // COMPLETE: Working loadAllQuizzes function
        async function loadAllQuizzes() {
            console.log('üìã Loading all quizzes for management...');
            
            const quizzesTableBody = document.getElementById('allQuizzesTable');
            
            // Show loading state
            if (quizzesTableBody) {
                quizzesTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading quizzes...</td></tr>';
            }
            
            try {
                let quizzes = [];
                
                // Try Google Sheets first
                try {
                    const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getQuizzes&t=${Date.now()}`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'success' && result.data && result.data.quizzes) {
                            quizzes = result.data.quizzes;
                            console.log(`‚úÖ Loaded ${quizzes.length} quizzes from Google Sheets`);
                        }
                    }
                } catch (error) {
                    console.warn('Using local data:', error);
                }
                
                // Fallback to localStorage
                if (quizzes.length === 0) {
                    quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                }
                
                // Populate table
                if (quizzesTableBody) {
                    if (quizzes.length === 0) {
                        quizzesTableBody.innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center py-5">
                                    <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                                    <h5>No quizzes found</h5>
                                    <p>Create your first quiz to get started!</p>
                                </td>
                            </tr>
                        `;
                    } else {
                        quizzesTableBody.innerHTML = quizzes.map((quiz, index) => {
                            const quizId = quiz.quizId || `quiz_${index}`;
                            const date = quiz.date || 'N/A';
                            const subject = quiz.subject || 'Unknown';
                            const totalQuestions = quiz.totalQuestions || (quiz.questions ? quiz.questions.length : 0);
                            const timeLimit = quiz.timeLimit || 0;
                            
                            return `
                                <tr>
                                    <td><input type="checkbox" class="quiz-checkbox" value="${quizId}"></td>
                                    <td><strong>${index + 1}</strong></td>
                                    <td><span class="badge bg-info">${date}</span></td>
                                    <td><span class="badge bg-primary">${subject}</span></td>
                                    <td class="text-center"><span class="badge bg-success">${totalQuestions}</span></td>
                                    <td class="text-center"><span class="badge bg-warning">${timeLimit} min</span></td>
                                    <td class="text-center"><span class="badge bg-secondary">0</span></td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewQuiz('${quizId}')" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteQuiz('${quizId}')" title="Delete Quiz">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
                
                return quizzes;
                
            } catch (error) {
                console.error('Error loading quizzes:', error);
                if (quizzesTableBody) {
                    quizzesTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center text-danger py-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error: ${error.message}
                                <button class="btn btn-sm btn-primary ms-2" onclick="loadAllQuizzes()">Retry</button>
                            </td>
                        </tr>
                    `;
                }
                return [];
            }
        }

        // Helper functions
        function viewQuiz(quizId) {
            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            const quiz = quizzes.find(q => q.quizId === quizId);
            
            if (quiz) {
                Swal.fire({
                    title: 'Quiz Details',
                    html: `
                        <div style="text-align: left;">
                            <p><strong>ID:</strong> ${quiz.quizId}</p>
                            <p><strong>Subject:</strong> ${quiz.subject}</p>
                            <p><strong>Date:</strong> ${quiz.date}</p>
                            <p><strong>Questions:</strong> ${quiz.questions ? quiz.questions.length : 0}</p>
                            <p><strong>Duration:</strong> ${quiz.timeLimit} minutes</p>
                        </div>
                    `,
                    icon: 'info'
                });
            } else {
                Swal.fire('Error', 'Quiz not found!', 'error');
            }
        }

        function deleteQuiz(quizId) {
            Swal.fire({
                title: 'Delete Quiz?',
                text: `Delete quiz ${quizId}? This cannot be undone.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Remove from localStorage
                    const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                    const updated = quizzes.filter(q => q.quizId !== quizId);
                    localStorage.setItem('quizzes', JSON.stringify(updated));
                    
                    Swal.fire('Deleted!', 'Quiz has been deleted.', 'success');
                    loadAllQuizzes(); // Reload
                    loadDashboardStats(); // Update dashboard
                }
            });
        }

        function selectAllQuizzes() {
            document.querySelectorAll('.quiz-checkbox').forEach(cb => cb.checked = true);
        }

        function deleteSelectedQuizzes() {
            const selected = Array.from(document.querySelectorAll('.quiz-checkbox:checked')).map(cb => cb.value);
            
            if (selected.length === 0) {
                Swal.fire('No Selection', 'Please select quizzes to delete.', 'warning');
                return;
            }
            
            Swal.fire({
                title: 'Delete Selected?',
                text: `Delete ${selected.length} selected quiz(es)?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'Yes, delete them!'
            }).then((result) => {
                if (result.isConfirmed) {
                    const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                    const updated = quizzes.filter(q => !selected.includes(q.quizId));
                    localStorage.setItem('quizzes', JSON.stringify(updated));
                    
                    Swal.fire('Deleted!', `${selected.length} quiz(es) deleted.`, 'success');
                    loadAllQuizzes();
                    loadDashboardStats();
                }
            });
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox');
            document.querySelectorAll('.quiz-checkbox').forEach(cb => cb.checked = selectAll.checked);
        }

        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                let quizzes = [];
                let attempts = [];
                
                try {
                    console.log('üì• Fetching data from Google Sheets...');
                    
                    const [quizzesResponse, attemptsResponse] = await Promise.all([
                        fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getQuizzes&t=${Date.now()}`, {
                            method: 'GET',
                            headers: { 'Accept': 'application/json' },
                            mode: 'cors'
                        }),
                        fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getLeaderboard&quizId=all&t=${Date.now()}`, {
                            method: 'GET',
                            headers: { 'Accept': 'application/json' },
                            mode: 'cors'
                        })
                    ]);
                    
                    if (quizzesResponse.ok) {
                        const quizzesResult = await quizzesResponse.json();
                        if (quizzesResult.status === 'success') {
                            quizzes = quizzesResult.data.quizzes || [];
                            console.log(`‚úÖ Loaded ${quizzes.length} quizzes from Google Sheets`);
                        }
                    }
                    
                    if (attemptsResponse.ok) {
                        const attemptsResult = await attemptsResponse.json();
                        if (attemptsResult.status === 'success') {
                            attempts = attemptsResult.data.leaderboard || [];
                            console.log(`‚úÖ Loaded ${attempts.length} attempts from Google Sheets`);
                        }
                    }
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to fetch from Google Sheets, using local data:', error);
                }
                
                // Fallback to localStorage if Google Sheets fails
                if (quizzes.length === 0) {
                    quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                }
                if (attempts.length === 0) {
                    attempts = JSON.parse(localStorage.getItem('quizAttempts') || '[]');
                }
                
                // Calculate statistics
                const today = new Date().toISOString().split('T')[0];
                const todayQuizzes = quizzes.filter(q => q.date === today);
                const totalQuestions = quizzes.reduce((sum, q) => sum + (q.totalQuestions || 0), 0);
                
                // Update dashboard cards
                document.getElementById('totalQuizzesCount').textContent = quizzes.length;
                document.getElementById('totalAttemptsCount').textContent = attempts.length;
                document.getElementById('todayQuizzesCount').textContent = todayQuizzes.length;
                document.getElementById('totalQuestionsCount').textContent = totalQuestions;
                
                console.log(`üìä Dashboard updated: ${quizzes.length} quizzes, ${attempts.length} attempts`);
                
            } catch (error) {
                console.error('‚ùå Error loading dashboard stats:', error);
            }
        }

        // Initialize charts (placeholder)
        function initializeCharts() {
            // Chart initialization code here
        }

        // Load analytics (placeholder) 
        function loadAnalytics() {
            // Analytics loading code here
        }

        // Utility functions
        function copyTemplate() {
            const template = `[
  {
    "question": "What is the capital of India?",
    "options": ["Mumbai", "New Delhi", "Kolkata", "Chennai"],
    "correctAnswer": 1,
    "explanation": "New Delhi is the capital of India since 1911.",
    "timeAllocation": 60
  }
]`;
            navigator.clipboard.writeText(template);
            Swal.fire('Copied!', 'Template copied to clipboard', 'success');
        }

        function loadSampleQuiz() {
            document.getElementById('questionsJson').value = `[
  {
    "question": "What is the capital of India?",
    "options": ["Mumbai", "New Delhi", "Kolkata", "Chennai"],
    "correctAnswer": 1,
    "explanation": "New Delhi is the capital of India since 1911.",
    "timeAllocation": 60
  },
  {
    "question": "Who is known as the Father of the Nation in India?",
    "options": ["Jawaharlal Nehru", "Mahatma Gandhi", "Sardar Patel", "Dr. APJ Abdul Kalam"],
    "correctAnswer": 1,
    "explanation": "Mahatma Gandhi is known as the Father of the Nation.",
    "timeAllocation": 60
  }
]`;
            validateJSON();
        }

        // Placeholder functions
        function handleChangePassword(e) { e.preventDefault(); }
    </script>

</body>
</html>
