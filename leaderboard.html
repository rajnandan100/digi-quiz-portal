<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Leaderboard - Digi Quiz Portal</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* Navigation Bar */
        .navbar {
            background: rgba(0,0,0,0.1) !important;
            backdrop-filter: blur(10px);
        }
        
        .main-container {
            background: white;
            border-radius: 25px;
            margin: 2rem auto;
            max-width: 1200px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .leaderboard-header {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .leaderboard-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .leaderboard-header .badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .filter-section {
            padding: 2rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .stats-section {
            padding: 2rem;
            background: white;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .stat-card h3 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .period-tabs {
            background: white;
            padding: 1.5rem 2rem 0 2rem;
        }
        
        .nav-pills .nav-link {
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-pills .nav-link.active {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }
        
        .leaderboard-content {
            padding: 0 2rem 2rem 2rem;
        }
        
        .search-download-section {
            background: white;
            padding: 1.5rem 2rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .leaderboard-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .table thead th {
            background: #1f2937;
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem;
        }
        
        .table tbody tr {
            transition: background-color 0.3s ease;
        }
        
        .table tbody tr:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }
        
        .table tbody tr.current-user {
            background-color: rgba(34, 197, 94, 0.1);
            border-left: 4px solid #10b981;
        }
        
        .rank-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
        }
        
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #1f2937; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); color: #1f2937; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #daa520); color: white; }
        .rank-default { background: #6b7280; }
        
        .trophy-icon {
            font-size: 1.5rem;
        }
        
        .trophy-gold { color: #ffd700; }
        .trophy-silver { color: #c0c0c0; }
        .trophy-bronze { color: #cd7f32; }
        
        .quiz-info-banner {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 1px solid #93c5fd;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        /* Banner Advertisement */
        .banner-ad-section {
            background: linear-gradient(45deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 20px;
            padding: 3rem 2rem;
            margin: 2rem 0;
            text-align: center;
            border: 2px dashed #cbd5e1;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .banner-ad-section h4 {
            color: #64748b;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .banner-ad-section i {
            color: #6366f1;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #64748b;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Sticky Bottom Ad */
        .sticky-bottom-ad {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1f2937;
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
            border-top: 3px solid #6366f1;
        }
        
        .sticky-bottom-ad .close-ad {
            position: absolute;
            top: 5px;
            right: 15px;
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .sticky-bottom-ad .close-ad:hover {
            color: white;
        }
        
        /* Footer */
        .footer {
            background: #1f2937;
            color: white;
            padding: 3rem 0 2rem 0;
            margin-top: 4rem;
        }
        
        .footer h5 {
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #f9fafb;
        }
        
        .footer .social-links a {
            color: #d1d5db;
            font-size: 1.5rem;
            margin-right: 15px;
            transition: all 0.3s;
        }
        
        .footer .social-links a:hover {
            color: #6366f1;
            transform: translateY(-2px);
        }
        
        .footer .footer-link {
            color: #d1d5db;
            text-decoration: none;
            transition: color 0.3s;
            display: block;
            padding: 5px 0;
        }
        
        .footer .footer-link:hover {
            color: #6366f1;
        }
        
        .footer .text-muted {
            color: #9ca3af !important;
        }
        
        .footer .fas.fa-heart {
            color: #ef4444 !important;
            animation: heartbeat 1.5s ease-in-out infinite;
        }
        
        @keyframes heartbeat {
            0% { transform: scale(1); }
            14% { transform: scale(1.2); }
            28% { transform: scale(1); }
            42% { transform: scale(1.2); }
            70% { transform: scale(1); }
        }
        
        @media (max-width: 768px) {
            .main-container {
                margin: 1rem;
                border-radius: 20px;
            }
            
            .leaderboard-header h1 {
                font-size: 2rem;
            }
            
            .filter-section,
            .stats-section,
            .period-tabs,
            .leaderboard-content,
            .search-download-section {
                padding: 1rem;
            }
            
            .sticky-bottom-ad {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .banner-ad-section {
                margin: 1rem 0;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="fas fa-graduation-cap me-2"></i>Digi Quiz Portal
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="leaderboard-header">
                <h1>
                    <i class="fas fa-trophy me-3"></i>Live Leaderboard
                </h1>
                <p class="lead mb-3">
                    <i class="fas fa-info-circle me-2"></i>Rankings updated in real-time
                </p>
                <div class="badge bg-success fs-6">
                    <i class="fas fa-sync-alt me-2"></i>Auto-refreshes every 30 seconds
                </div>
            </div>

            <!-- Quiz Selector & Filters -->
            <div class="filter-section">
                <div class="row align-items-center g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold mb-2">
                            <i class="fas fa-filter me-2 text-primary"></i>Select Quiz
                        </label>
                        <select class="form-select form-select-lg" id="quizSelector">
                            <option value="all">All Quizzes Combined</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2 align-items-end h-100">
                            <button class="btn btn-primary" onclick="loadLeaderboard()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh
                            </button>
                            <button class="btn btn-warning" onclick="resetFilters()">
                                <i class="fas fa-redo me-2"></i>Reset Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quiz Info Banner -->
            <div id="quizInfoBanner" class="quiz-info-banner" style="display: none;">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2">
                            <i class="fas fa-book-reader me-2"></i>
                            <strong id="selectedQuizSubject">Subject</strong>
                        </h5>
                        <p class="mb-0">
                            <i class="fas fa-calendar me-2"></i><span id="selectedQuizDate">Date</span>
                            &nbsp;&nbsp;
                            <i class="fas fa-question-circle me-2"></i><span id="selectedQuizQuestions">0</span> Questions
                            &nbsp;&nbsp;
                            <i class="fas fa-clock me-2"></i><span id="selectedQuizDuration">0</span> Minutes
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewAllQuizzes()">
                            <i class="fas fa-eye me-1"></i>View All Quizzes
                        </button>
                    </div>
                </div>
            </div>

            <!-- Time Period Tabs -->
            <div class="period-tabs">
                <ul class="nav nav-pills mb-4 justify-content-center" id="periodTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-period="today" type="button" role="tab">
                            <i class="fas fa-calendar-day me-1"></i>Today
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-period="week" type="button" role="tab">
                            <i class="fas fa-calendar-week me-1"></i>This Week
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-period="month" type="button" role="tab">
                            <i class="fas fa-calendar-alt me-1"></i>This Month
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-period="all" type="button" role="tab">
                            <i class="fas fa-infinity me-1"></i>All Time
                        </button>
                    </li>
                </ul>
            </div>

            <!-- Stats Dashboard -->
            <div class="stats-section">
                <div class="row g-3 mb-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="stat-card">
                            <i class="fas fa-users text-primary"></i>
                            <h3 id="totalParticipants">0</h3>
                            <p class="mb-0 text-muted">Total Participants</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stat-card">
                            <i class="fas fa-chart-line text-success"></i>
                            <h3 id="averageScore">0%</h3>
                            <p class="mb-0 text-muted">Average Score</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stat-card">
                            <i class="fas fa-star text-warning"></i>
                            <h3 id="highestScore">0%</h3>
                            <p class="mb-0 text-muted">Highest Score</p>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="stat-card">
                            <i class="fas fa-ranking-star text-info"></i>
                            <h3 id="yourRank">-</h3>
                            <p class="mb-0 text-muted">Your Rank</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Banner Advertisement Section -->
            <div class="banner-ad-section">
                <i class="fas fa-bullhorn fa-3x mb-3"></i>
                <h4>Premium Advertisement Space</h4>
                <p>728x90 Banner Advertisement - Perfect for Brand Promotion</p>
                <small class="text-muted">Contact us for advertising opportunities</small>
            </div>

            <!-- Search and Download -->
            <div class="search-download-section">
                <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
                    <input type="text" id="searchUser" class="form-control" style="max-width: 400px;" placeholder="🔍 Search by name...">
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="downloadCertificate()">
                            <i class="fas fa-certificate me-2"></i>Download Certificate
                        </button>
                        <button class="btn btn-danger" onclick="downloadPDF()">
                            <i class="fas fa-file-pdf me-2"></i>Download PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Table -->
            <div class="leaderboard-content">
                <div class="leaderboard-table">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="leaderboardTable">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-medal me-1"></i>Rank</th>
                                    <th><i class="fas fa-user me-1"></i>Name</th>
                                    <th><i class="fas fa-check-circle me-1"></i>Score</th>
                                    <th><i class="fas fa-percentage me-1"></i>Accuracy</th>
                                    <th><i class="fas fa-clock me-1"></i>Time Taken</th>
                                    <th><i class="fas fa-calendar me-1"></i>Date</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody">
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="spinner-border text-primary mb-3"></div>
                                        <p>Loading leaderboard...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4 mb-md-0">
                    <h5>
                        <i class="fas fa-graduation-cap me-2"></i>Digi Quiz Portal
                    </h5>
                    <p class="text-muted">Empowering students with quality practice tests for government exams and competitive assessments.</p>
                    <div class="social-links mt-3">
                        <a href="#" title="Facebook"><i class="fab fa-facebook"></i></a>
                        <a href="#" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="#" title="Telegram"><i class="fab fa-telegram"></i></a>
                        <a href="#" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                        <a href="#" title="YouTube"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <div class="col-md-4 mb-4 mb-md-0">
                    <h5>Quick Links</h5>
                    <div class="row">
                        <div class="col-6">
                            <a href="index.html" class="footer-link">
                                <i class="fas fa-home me-2"></i>Home
                            </a>
                            <a href="result.html" class="footer-link">
                                <i class="fas fa-chart-bar me-2"></i>Results
                            </a>
                            <a href="admin.html" class="footer-link">
                                <i class="fas fa-cog me-2"></i>Admin Panel
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="#" class="footer-link">
                                <i class="fas fa-question-circle me-2"></i>Help
                            </a>
                            <a href="#" class="footer-link">
                                <i class="fas fa-shield-alt me-2"></i>Privacy Policy
                            </a>
                            <a href="#" class="footer-link">
                                <i class="fas fa-file-contract me-2"></i>Terms
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>Contact Info</h5>
                    <div class="contact-info">
                        <p class="text-muted mb-2">
                            <i class="fas fa-envelope me-2"></i>support@digiquizportal.com
                        </p>
                        <p class="text-muted mb-2">
                            <i class="fas fa-phone me-2"></i>+91 12345 67890
                        </p>
                        <p class="text-muted mb-2">
                            <i class="fas fa-map-marker-alt me-2"></i>New Delhi, India
                        </p>
                        <p class="text-muted">
                            <i class="fas fa-clock me-2"></i>24/7 Support Available
                        </p>
                    </div>
                </div>
            </div>
            
            <hr style="border-color: #374151; margin: 2rem 0 1rem 0;">
            
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start">
                    <p class="text-muted mb-0">
                        &copy; 2025 Digi Quiz Portal. All rights reserved.
                    </p>
                </div>
                <div class="col-md-6 text-center text-md-end mt-2 mt-md-0">
                    <small class="text-muted">
                        Made with <i class="fas fa-heart"></i> for Students
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Sticky Bottom Advertisement -->
    <div class="sticky-bottom-ad" id="stickyAd">
        <button class="close-ad" onclick="closeStickyAd()" title="Close Ad">
            <i class="fas fa-times"></i>
        </button>
        <h5>
            <i class="fas fa-trophy me-2"></i>Compete & Win Prizes!
        </h5>
        <p>Join weekly quiz competitions and win exciting prizes. Register now!</p>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- API JS -->
    <script src="js/api.js"></script>
    
    <script>
        let currentPeriod = 'all';
        let currentQuizId = 'all';
        let allLeaderboardData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Leaderboard page loading...');
            
            // Check if QuizAPI is loaded
            if (typeof window.QuizAPI === 'undefined') {
                console.error('QuizAPI not loaded! Check if api.js is included.');
                Swal.fire('Error', 'API not loaded. Please refresh the page.', 'error');
                return;
            }

            loadQuizSelector();
            checkForSpecificQuiz();
            
            // Sync attempts from Google Sheets first
            await syncAttemptsFromServer();
            
            // Then load leaderboard
            await loadLeaderboard();
            
            setupEventListeners();
            
            // Auto-refresh every 30 seconds
            setInterval(loadLeaderboard, 30000);
        });

        // Sync attempts from Google Sheets on page load
        async function syncAttemptsFromServer() {
            try {
                if (!window.QuizAPI || typeof window.QuizAPI.getLeaderboard !== 'function') {
                    console.warn('QuizAPI.getLeaderboard not available');
                    return false;
                }

                console.log('Syncing attempts from Google Sheets...');
                const serverAttempts = await window.QuizAPI.getLeaderboard('all');
                console.log('Server response:', serverAttempts);

                if (serverAttempts && serverAttempts.length > 0) {
                    // Merge with local attempts
                    const localAttempts = JSON.parse(localStorage.getItem('quizAttempts') || '[]');
                    
                    // Create map to avoid duplicates
                    const attemptMap = new Map();
                    
                    // Add server attempts first (they are authoritative)
                    serverAttempts.forEach(attempt => {
                        const key = `${attempt.email}_${attempt.quizId}_${attempt.date}`;
                        attemptMap.set(key, attempt);
                    });
                    
                    // Add local attempts that don't exist on server
                    localAttempts.forEach(attempt => {
                        const key = `${attempt.email}_${attempt.quizId}_${attempt.date}`;
                        if (!attemptMap.has(key)) {
                            attemptMap.set(key, attempt);
                        }
                    });
                    
                    // Save merged attempts
                    const mergedAttempts = Array.from(attemptMap.values());
                    localStorage.setItem('quizAttempts', JSON.stringify(mergedAttempts));
                    
                    console.log(`Synced ${serverAttempts.length} attempts from server`);
                    console.log(`Total attempts after merge: ${mergedAttempts.length}`);
                    return true;
                } else {
                    console.log('No attempts found on server');
                    return false;
                }
            } catch (error) {
                console.error('Sync error:', error);
                return false;
            }
        }

        // Check if redirected from results page with specific quiz
        function checkForSpecificQuiz() {
            const urlParams = new URLSearchParams(window.location.search);
            const quizId = urlParams.get('quizId');
            if (quizId && quizId !== 'all') {
                currentQuizId = quizId;
                const selector = document.getElementById('quizSelector');
                if (selector) {
                    selector.value = quizId;
                }
                console.log('Showing leaderboard for quiz:', quizId);
            }
        }

        // Load quiz selector dropdown
        function loadQuizSelector() {
            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            const selector = document.getElementById('quizSelector');
            
            // Sort by date (newest first)
            quizzes.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Clear existing options except 'All Quizzes'
            selector.innerHTML = '<option value="all">All Quizzes Combined</option>';
            
            quizzes.forEach(quiz => {
                const option = document.createElement('option');
                option.value = quiz.quizId;
                option.textContent = `${quiz.subject} - ${new Date(quiz.date).toLocaleDateString('en-IN')}`;
                selector.appendChild(option);
            });
            
            // Set current selection
            if (currentQuizId) {
                selector.value = currentQuizId;
            }
            
            console.log(`Loaded ${quizzes.length} quizzes in selector`);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Quiz selector change
            document.getElementById('quizSelector').addEventListener('change', function(e) {
                currentQuizId = e.target.value;
                loadLeaderboard();
            });

            // Period tabs
            document.querySelectorAll('#periodTabs button').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#periodTabs button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentPeriod = this.dataset.period;
                    loadLeaderboard();
                });
            });

            // Search
            document.getElementById('searchUser').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#leaderboardBody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // Load leaderboard data
        async function loadLeaderboard() {
            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            console.log('Loading leaderboard for:', currentQuizId, 'period:', currentPeriod);
            
            // Show loading state
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <div class="spinner-border text-primary mb-3"></div>
                        <p>Loading leaderboard data...</p>
                    </td>
                </tr>
            `;

            // Load from localStorage (which should be synced from Google Sheets)
            const attempts = JSON.parse(localStorage.getItem('quizAttempts') || '[]');
            console.log(`Loaded ${attempts.length} attempts from localStorage`);

            // Show empty state if no data
            if (attempts.length === 0) {
                showEmptyState();
                return;
            }

            // Filter by selected quiz
            let filteredAttempts = attempts;
            if (currentQuizId !== 'all') {
                filteredAttempts = attempts.filter(a => a.quizId === currentQuizId);
                showQuizInfo(currentQuizId, quizzes);
            } else {
                hideQuizInfo();
            }

            // Filter by time period
            filteredAttempts = filterByPeriod(filteredAttempts, currentPeriod);

            // Remove duplicates (keep best attempt per user per quiz)
            filteredAttempts = removeDuplicates(filteredAttempts);

            // Sort by score (descending), then by time (ascending)
            filteredAttempts.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return timeToSeconds(a.time) - timeToSeconds(b.time);
            });

            allLeaderboardData = filteredAttempts;

            updateStats(filteredAttempts);
            displayLeaderboard(filteredAttempts);
            
            console.log(`Displaying ${filteredAttempts.length} attempts on leaderboard`);
        }

        // Show empty state
        function showEmptyState() {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h5>No Quiz Attempts Yet</h5>
                        <p>Be the first to take a quiz and appear on the leaderboard!</p>
                        <a href="index.html" class="btn btn-primary mt-3">
                            <i class="fas fa-play me-2"></i>Take a Quiz
                        </a>
                    </td>
                </tr>
            `;

            // Reset stats
            document.getElementById('totalParticipants').textContent = '0';
            document.getElementById('averageScore').textContent = '0%';
            document.getElementById('highestScore').textContent = '0%';
            document.getElementById('yourRank').textContent = '-';
            
            allLeaderboardData = [];
        }

        // Show quiz info banner
        function showQuizInfo(quizId, quizzes) {
            const quiz = quizzes.find(q => q.quizId === quizId);
            if (quiz) {
                document.getElementById('quizInfoBanner').style.display = 'block';
                document.getElementById('selectedQuizSubject').textContent = quiz.subject;
                document.getElementById('selectedQuizDate').textContent = new Date(quiz.date).toLocaleDateString('en-IN');
                document.getElementById('selectedQuizQuestions').textContent = quiz.totalQuestions;
                document.getElementById('selectedQuizDuration').textContent = Math.ceil(quiz.timeLimit / 60);
            }
        }

        function hideQuizInfo() {
            document.getElementById('quizInfoBanner').style.display = 'none';
        }

        // Remove duplicate attempts (keep best score per user per quiz)
        function removeDuplicates(attempts) {
            const uniqueMap = new Map();
            
            attempts.forEach(attempt => {
                const key = `${attempt.email}_${attempt.quizId}`;
                if (!uniqueMap.has(key)) {
                    uniqueMap.set(key, attempt);
                } else {
                    const existing = uniqueMap.get(key);
                    if (attempt.score > existing.score || 
                        (attempt.score === existing.score && timeToSeconds(attempt.time) < timeToSeconds(existing.time))) {
                        uniqueMap.set(key, attempt);
                    }
                }
            });
            
            return Array.from(uniqueMap.values());
        }

        // Convert time string to seconds
        function timeToSeconds(time) {
            if (!time) return 999999;
            const parts = time.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }

        // Filter by time period
        function filterByPeriod(attempts, period) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            return attempts.filter(attempt => {
                const attemptDate = new Date(attempt.date);
                
                switch (period) {
                    case 'today':
                        return attempt.date === today;
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return attemptDate >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        return attemptDate >= monthAgo;
                    default:
                        return true;
                }
            });
        }

        // Update statistics
        function updateStats(data) {
            document.getElementById('totalParticipants').textContent = data.length;

            if (data.length > 0) {
                const avgScore = data.reduce((sum, d) => sum + d.accuracy, 0) / data.length;
                document.getElementById('averageScore').textContent = avgScore.toFixed(1) + '%';

                const maxScore = Math.max(...data.map(d => d.accuracy), 0);
                document.getElementById('highestScore').textContent = maxScore.toFixed(1) + '%';

                // Find user's rank
                const session = JSON.parse(localStorage.getItem('userSession') || '{}');
                if (session.email) {
                    const userIndex = data.findIndex(d => d.email === session.email);
                    if (userIndex >= 0) {
                        document.getElementById('yourRank').textContent = userIndex + 1;
                    } else {
                        document.getElementById('yourRank').textContent = '-';
                    }
                } else {
                    document.getElementById('yourRank').textContent = '-';
                }
            } else {
                document.getElementById('averageScore').textContent = '0%';
                document.getElementById('highestScore').textContent = '0%';
                document.getElementById('yourRank').textContent = '-';
            }
        }

        // Display leaderboard table
        function displayLeaderboard(data) {
            const tbody = document.getElementById('leaderboardBody');
            const session = JSON.parse(localStorage.getItem('userSession') || '{}');
            const currentUserEmail = session.email;

            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No attempts for this quiz/period yet</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map((entry, index) => {
                const isCurrentUser = entry.email === currentUserEmail;
                const rowClass = isCurrentUser ? 'current-user' : '';

                let rankDisplay = '';
                if (index === 0) {
                    rankDisplay = `<div class="rank-badge rank-1"><i class="fas fa-trophy trophy-gold"></i></div>`;
                } else if (index === 1) {
                    rankDisplay = `<div class="rank-badge rank-2"><i class="fas fa-trophy trophy-silver"></i></div>`;
                } else if (index === 2) {
                    rankDisplay = `<div class="rank-badge rank-3"><i class="fas fa-trophy trophy-bronze"></i></div>`;
                } else {
                    rankDisplay = `<div class="rank-badge rank-default">${index + 1}</div>`;
                }

                // Format time properly
                let displayTime = entry.time || '00:00';
                
                // Format date
                let displayDate = 'N/A';
                try {
                    let dateStr = entry.date || entry.attemptDate;
                    if (dateStr) {
                        if (dateStr.includes('T')) {
                            dateStr = dateStr.split('T')[0];
                        }
                        const dateObj = new Date(dateStr);
                        if (!isNaN(dateObj.getTime())) {
                            displayDate = dateObj.toLocaleDateString('en-IN', {
                                day: 'numeric',
                                month: 'short',
                                year: 'numeric'
                            });
                        }
                    }
                } catch (e) {
                    console.error('Date parsing error:', e);
                }

                return `
                    <tr class="${rowClass}">
                        <td>${rankDisplay}</td>
                        <td>
                            <i class="fas fa-user-circle me-2"></i>${entry.userName || entry.name}
                            ${isCurrentUser ? '<span class="badge bg-primary ms-2">You</span>' : ''}
                        </td>
                        <td><strong>${entry.score}/${entry.total || 30}</strong></td>
                        <td><span class="badge bg-success">${(entry.accuracy || 0).toFixed(1)}%</span></td>
                        <td><i class="fas fa-stopwatch me-1"></i>${displayTime}</td>
                        <td><i class="fas fa-calendar-day me-1"></i>${displayDate}</td>
                    </tr>
                `;
            }).join('');
        }

        // Download Certificate
        function downloadCertificate() {
            // Get user's best attempt
            const session = JSON.parse(localStorage.getItem('userSession') || '{}');
            
            if (!session.email) {
                Swal.fire({
                    title: 'Login Required',
                    text: 'Please complete a quiz first to generate certificate',
                    icon: 'warning'
                });
                return;
            }

            const userAttempts = allLeaderboardData.filter(a => a.email === session.email);
            
            if (userAttempts.length === 0) {
                Swal.fire({
                    title: 'No Quiz Attempts',
                    text: 'Complete a quiz to generate your certificate',
                    icon: 'info'
                }).then(() => {
                    window.location.href = 'index.html';
                });
                return;
            }

            // Get best attempt
            const bestAttempt = userAttempts.sort((a, b) => b.accuracy - a.accuracy)[0];
            
            generateCertificate(bestAttempt);
        }

        // Generate Professional Certificate
        function generateCertificate(attempt) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape', 'mm', 'a4');

                const pageWidth = 297;
                const pageHeight = 210;
                
                // Background color
                doc.setFillColor(249, 250, 251);
                doc.rect(0, 0, pageWidth, pageHeight, 'F');

                // Border
                doc.setDrawColor(99, 102, 241);
                doc.setLineWidth(3);
                doc.rect(10, 10, pageWidth-20, pageHeight-20);

                // Inner border
                doc.setDrawColor(139, 92, 246);
                doc.setLineWidth(1);
                doc.rect(15, 15, pageWidth-30, pageHeight-30);

                // Header
                doc.setTextColor(99, 102, 241);
                doc.setFontSize(28);
                doc.setFont('helvetica', 'bold');
                doc.text('CERTIFICATE OF ACHIEVEMENT', pageWidth/2, 40, { align: 'center' });

                // Subtitle
                doc.setTextColor(75, 85, 99);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('Digi Quiz Portal', pageWidth/2, 50, { align: 'center' });

                // Main content
                doc.setTextColor(31, 41, 55);
                doc.setFontSize(16);
                doc.text('This is to certify that', pageWidth/2, 70, { align: 'center' });

                // Name
                doc.setTextColor(99, 102, 241);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text(attempt.userName || attempt.name, pageWidth/2, 85, { align: 'center' });

                // Achievement text
                doc.setTextColor(31, 41, 55);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'normal');
                doc.text('has successfully completed the quiz', pageWidth/2, 100, { align: 'center' });

                // Quiz details
                const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                const quiz = quizzes.find(q => q.quizId === attempt.quizId);
                const quizTitle = quiz ? quiz.subject : 'Quiz';
                
                doc.setTextColor(99, 102, 241);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(`"${quizTitle}"`, pageWidth/2, 115, { align: 'center' });

                // Performance details
                doc.setTextColor(31, 41, 55);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                
                const accuracy = attempt.accuracy || 0;
                doc.text(`with a score of ${attempt.score}/${attempt.total || 30} (${accuracy.toFixed(1)}%)`, pageWidth/2, 130, { align: 'center' });

                // Motivational quote based on performance
                let quote = '';
                if (accuracy >= 50) {
                    quote = '"Excellence is not a skill, it\'s an attitude. Keep up the great work!"';
                } else {
                    quote = '"Every expert was once a beginner. Keep learning and improving!"';
                }
                
                doc.setTextColor(75, 85, 99);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'italic');
                doc.text(quote, pageWidth/2, 145, { align: 'center' });

                // Date and time
                doc.setTextColor(107, 114, 128);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                
                const attemptDate = new Date(attempt.date);
                const dateStr = attemptDate.toLocaleDateString('en-IN', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
                
                doc.text(`Date of Achievement: ${dateStr}`, pageWidth/2, 160, { align: 'center' });
                doc.text(`Certificate Generated: ${new Date().toLocaleDateString('en-IN')}`, pageWidth/2, 170, { align: 'center' });

                // Signature area
                doc.setDrawColor(156, 163, 175);
                doc.setLineWidth(0.5);
                doc.line(50, 185, 120, 185);
                doc.line(177, 185, 247, 185);

                doc.setTextColor(107, 114, 128);
                doc.setFontSize(10);
                doc.text('Digital Signature', 85, 192, { align: 'center' });
                doc.text('Digi Quiz Portal', 212, 192, { align: 'center' });

                // Certificate ID
                const certificateId = `DQP-${Date.now()}-${attempt.email.substring(0,3).toUpperCase()}`;
                doc.setTextColor(156, 163, 175);
                doc.setFontSize(8);
                doc.text(`Certificate ID: ${certificateId}`, pageWidth/2, 200, { align: 'center' });

                // Save the PDF
                const fileName = `Certificate-${attempt.userName || 'Student'}-${quizTitle.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);

                Swal.fire({
                    title: 'Certificate Generated!',
                    text: 'Your certificate has been downloaded successfully',
                    icon: 'success',
                    timer: 3000,
                    showConfirmButton: false
                });

            } catch (error) {
                console.error('Certificate generation error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to generate certificate. Please try again.',
                    icon: 'error'
                });
            }
        }

        // Reset filters
        function resetFilters() {
            currentQuizId = 'all';
            currentPeriod = 'all';
            document.getElementById('quizSelector').value = 'all';
            document.querySelectorAll('#periodTabs button').forEach(b => b.classList.remove('active'));
            document.querySelector('#periodTabs button[data-period="all"]').classList.add('active');
            document.getElementById('searchUser').value = '';
            loadLeaderboard();
        }

        // View all quizzes
        function viewAllQuizzes() {
            window.location.href = 'index.html';
        }

        // Download PDF
        function downloadPDF() {
            if (allLeaderboardData.length === 0) {
                Swal.fire({
                    title: 'No Data',
                    text: 'No leaderboard data available',
                    icon: 'info'
                });
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                const quiz = quizzes.find(q => q.quizId === currentQuizId);
                const quizName = currentQuizId === 'all' ? 'All Quizzes' : (quiz ? quiz.subject : 'Selected Quiz');

                // Title
                doc.setFontSize(20);
                doc.setTextColor(99, 102, 241);
                doc.text('Digi Quiz Portal - Leaderboard', 105, 20, { align: 'center' });

                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Quiz: ${quizName}`, 105, 30, { align: 'center' });
                doc.text(`Period: ${currentPeriod.toUpperCase()}`, 105, 37, { align: 'center' });
                doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 44, { align: 'center' });

                // Table data
                const tableData = allLeaderboardData.map((entry, index) => [
                    index + 1,
                    entry.userName || entry.name,
                    `${entry.score}/${entry.total || 30}`,
                    `${(entry.accuracy || 0).toFixed(1)}%`,
                    entry.time,
                    entry.date
                ]);

                doc.autoTable({
                    startY: 50,
                    head: [['Rank', 'Name', 'Score', 'Accuracy', 'Time', 'Date']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [99, 102, 241], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [249, 250, 251] },
                    styles: { fontSize: 10 }
                });

                doc.save(`leaderboard-${quizName.replace(/\s+/g, '-')}-${currentPeriod}-${new Date().toISOString().split('T')[0]}.pdf`);

                Swal.fire({
                    title: 'Success!',
                    text: 'PDF downloaded!',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to generate PDF',
                    icon: 'error'
                });
            }
        }

        // Close sticky ad functionality
        function closeStickyAd() {
            const stickyAd = document.getElementById('stickyAd');
            stickyAd.style.transform = 'translateY(100%)';
            setTimeout(() => {
                stickyAd.style.display = 'none';
                document.body.style.paddingBottom = '0';
            }, 300);
        }

        // Auto-hide sticky ad after 10 seconds
        setTimeout(() => {
            const stickyAd = document.getElementById('stickyAd');
            if (stickyAd) {
                stickyAd.style.opacity = '0.8';
            }
        }, 10000);
    </script>
</body>
</html>
